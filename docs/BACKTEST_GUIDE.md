# 🎯 NOFX 回测功能使用指南

> **版本**: v1.0
> **更新日期**: 2025-01-15
> **适用于**: NOFX AI 交易系统

---

## 📚 目录

1. [什么是回测？](#什么是回测)
2. [为什么需要回测？](#为什么需要回测)
3. [快速开始](#快速开始)
4. [功能特性](#功能特性)
5. [使用指南](#使用指南)
6. [成本分析](#成本分析)
7. [最佳实践](#最佳实践)
8. [常见问题](#常见问题)
9. [技术细节](#技术细节)

---

## 什么是回测？

### 一句话解释

**回测 = 用历史数据测试你的 AI 交易策略，看它是否靠谱，而不用花真钱。**

### 简单比喻

就像：
- 🎮 游戏中的 **练习模式**（不扣血，可以试错）
- 🚗 驾校的 **模拟器**（撞了也不赔钱）
- 📝 考试前的 **模拟题**（不计入成绩，但能发现问题）

### 实际场景

想象你开发了一个 AI 交易策略：

**❌ 错误做法**：
```
直接用真钱实盘 → AI 判断错误 → 亏损真金白银 → 😭
```

**✅ 正确做法**：
```
用历史数据回测 → 发现策略有问题 → 改进策略 → 再回测 → 直到满意 → 小资金试水 → 逐步加仓 → ✅
```

---

## 为什么需要回测？

### 🎯 核心价值

#### 1. **降低风险**
```
回测结果：月收益 -15%，最大回撤 -40%
↓
结论：策略有问题，不能用真钱
↓
节省：避免了可能的重大亏损 ✅
```

#### 2. **快速迭代**
```
实盘测试：需要 30 天才能看到结果
回测测试：2 分钟就能模拟 30 天

效率提升：21,600 倍 🚀
```

#### 3. **数据驱动**
```
凭感觉："我觉得这个策略应该能赚钱"
看数据："回测显示胜率 62%，夏普比率 1.8，最大回撤 8%"

决策质量：有数据支撑 ✅
```

#### 4. **参数优化**
```
测试 100 种参数组合：
- 不同的杠杆倍数（5x, 10x, 20x）
- 不同的止损位（3%, 5%, 10%）
- 不同的决策频率（1h, 4h, 1d）

找到最优组合 ✅
```

---

## 快速开始

### 前置要求

- ✅ NOFX 系统已部署
- ✅ AI API Key 已配置（DeepSeek/GPT-4/Claude）
- ✅ 有网络访问 Binance API

### 5 分钟快速体验

#### Step 1: 访问回测页面

![访问回测页面](./images/backtest-navigation.png)
<!-- 📸 TODO: 添加截图 - 点击 Header 中的 "Backtest" 按钮 -->

1. 登录 NOFX 系统
2. 点击顶部导航栏的 **"Backtest"** 按钮
3. 进入回测配置页面

---

#### Step 2: 配置回测参数

![配置回测参数](./images/backtest-config.png)
<!-- 📸 TODO: 添加截图 - 回测配置表单 -->

**推荐的第一次配置**（快速、省钱）：

```yaml
Run ID: my_first_backtest
初始资金: 10,000 USDT
交易对: BTCUSDT
时间范围: 最近 24 小时  # 点击快捷按钮 "24h"
AI 模型: deepseek-chat
决策间隔: 1h  # 1小时决策一次（省 token）
```

**预估成本**：
- AI Token 消耗: ~60,000 tokens
- 费用: < $0.01 USD（1 分钱人民币）
- 完成时间: < 30 秒

---

#### Step 3: 启动回测

![启动回测](./images/backtest-running.png)
<!-- 📸 TODO: 添加截图 - 回测运行中的界面 -->

1. 点击 **"Start Backtest"** 按钮
2. 观察进度条和实时指标：
   ```
   Status: Running
   Progress: 15/24 cycles (62%)
   Current Equity: 10,245 USDT (+2.45%)
   Current Positions: 1 (BTCUSDT LONG)
   ```

---

#### Step 4: 查看结果

![回测结果](./images/backtest-results.png)
<!-- 📸 TODO: 添加截图 - 回测结果报告 -->

回测完成后，你会看到：

**📊 核心指标**：
```
✅ 总收益率: +12.5%
📈 最大回撤: -5.3%
🎯 胜率: 58.3%
💰 盈亏比: 2.1
📝 总交易: 24 笔
```

**📈 净值曲线**：
![净值曲线](./images/equity-curve.png)
<!-- 📸 TODO: 添加截图 - 净值曲线图 -->

**📋 交易明细**：
![交易明细](./images/trade-list.png)
<!-- 📸 TODO: 添加截图 - 交易明细列表 -->

---

## 功能特性

### ✨ 核心功能

#### 1. **完整的交易模拟**
- ✅ 真实的市场数据（来自 Binance）
- ✅ 真实的 AI 决策引擎（与实盘相同）
- ✅ 真实的交易成本（手续费 + 滑点）
- ✅ 真实的风险管理（爆仓检测、风控限制）

#### 2. **灵活的配置**
```json
{
  "symbols": ["BTCUSDT", "ETHUSDT"],      // 支持多币种
  "timeframes": ["3m", "15m", "4h"],      // 多时间框架
  "decision_timeframe": "3m",             // 决策频率
  "initial_balance": 10000,               // 初始资金
  "fee_bps": 5,                           // 手续费 (5 bps = 0.05%)
  "slippage_bps": 2,                      // 滑点 (2 bps = 0.02%)
  "start_ts": 1704067200,                 // 开始时间
  "end_ts": 1704672000                    // 结束时间
}
```

#### 3. **AI 决策缓存**
- 首次运行：完整调用 AI API（付费）
- 后续相同参数：使用缓存（免费）
- 节省成本：高达 90%

#### 4. **丰富的分析报告**

**收益指标**：
- 总收益率
- 年化收益率
- 夏普比率（风险调整后收益）

**风险指标**：
- 最大回撤
- 最大回撤持续时间
- 波动率

**交易统计**：
- 总交易次数
- 胜率
- 盈亏比
- 平均持仓时间

#### 5. **实时监控**
- 进度条显示
- 实时净值更新
- 当前持仓展示
- 错误日志查看

---

## 使用指南

### 📋 配置参数详解

#### 基础参数

| 参数 | 说明 | 默认值 | 推荐值 |
|------|------|--------|--------|
| `run_id` | 回测任务唯一标识 | - | 使用有意义的名称 |
| `initial_balance` | 初始资金（USDT） | - | 10,000 - 100,000 |
| `symbols` | 交易币对列表 | - | 1-5 个币对 |
| `start_ts` | 开始时间戳 | - | 近期数据 |
| `end_ts` | 结束时间戳 | - | 1-30 天范围 |

#### AI 配置

| 参数 | 说明 | 可选值 | 推荐 |
|------|------|--------|------|
| `ai_provider` | AI 提供商 | `deepseek`, `openai`, `claude` | `deepseek`（性价比高） |
| `ai_model` | AI 模型 | `deepseek-chat`, `gpt-4o`, `claude-3.5-sonnet` | `deepseek-chat` |

#### 交易参数

| 参数 | 说明 | 默认值 | 建议范围 |
|------|------|--------|----------|
| `timeframes` | K线时间框架 | `["3m", "15m", "4h"]` | 包含短、中、长周期 |
| `decision_timeframe` | 决策周期 | `3m` | 与实盘一致 |
| `fee_bps` | 手续费（基点） | 5 | 5-10 bps |
| `slippage_bps` | 滑点（基点） | 2 | 2-5 bps |

---

### 🎯 时间范围选择

#### 快捷选项

| 选项 | 时长 | 决策次数 (1h) | Token 消耗 | 费用 | 适用场景 |
|------|------|--------------|-----------|------|----------|
| **24h** | 1 天 | 24 | 60K | $0.01 | 快速验证 |
| **3d** | 3 天 | 72 | 180K | $0.04 | 短期测试 |
| **7d** | 7 天 | 168 | 420K | $0.08 | 周级回测 |

#### 自定义时间

```javascript
// 示例：测试 2024 年 1 月的完整月度表现
{
  "start_ts": 1704067200,  // 2024-01-01 00:00:00
  "end_ts": 1706745600     // 2024-02-01 00:00:00
}

// 决策次数: 31 天 × 24 小时 = 744 次
// 费用（DeepSeek）: ~$0.37
```

---

### ⚙️ 决策频率配置

#### ⚠️ 重要：必须与实盘一致

**生产环境**：
```
实时交易决策间隔: 3 分钟
```

**回测配置**：
```json
{
  "decision_timeframe": "3m"  // ← 必须设置为 3m
}
```

**如果不一致会怎样？**

| 回测频率 | 实盘频率 | 结果 | 原因 |
|---------|---------|------|------|
| 1h | 3m | ❌ 回测高估收益 | 忽略了高频交易的手续费累积 |
| 3m | 3m | ✅ 结果接近 | 一致的决策频率 |
| 1m | 3m | ❌ 回测低估收益 | 过度考虑了短期噪音 |

#### Token 消耗对比

| 决策频率 | 7天决策次数 | Token 消耗 | 费用 (DeepSeek) |
|---------|------------|-----------|----------------|
| **1h** | 168 | 420K | $0.08 |
| **15m** | 672 | 1.68M | $0.34 |
| **3m** ⭐ | 3,360 | 8.4M | $1.76 |
| **1m** | 10,080 | 25.2M | $5.29 |

**💡 省钱策略**：
```bash
# Phase 1: 粗粒度验证（省钱）
decision_timeframe: 1h
时长: 7 天
费用: $0.08
目的: 快速验证策略大方向

# Phase 2: 精确测试（接近实盘）
decision_timeframe: 3m
时长: 1-3 天
费用: $0.75 (3天)
目的: 精确验证实盘表现
```

---

## 成本分析

### 💰 AI Token 消耗详解

#### 单次决策消耗

```
Input Tokens (发送给 AI):
┌─────────────────────────────┐
│ System Prompt:    ~1,000    │
│ Market Data:      ~500      │
│ Current Positions: ~300     │
│ Historical Context: ~200    │
├─────────────────────────────┤
│ 总计:             ~2,000    │
└─────────────────────────────┘

Output Tokens (AI 返回):
┌─────────────────────────────┐
│ AI 分析 + 决策:   ~500      │
└─────────────────────────────┘

单次总消耗 = 2,500 tokens
```

#### 不同模型价格对比

| AI 模型 | Input 价格 | Output 价格 | 7天回测 (3m频率) | 性价比 |
|---------|-----------|-------------|-----------------|--------|
| **DeepSeek** | $0.14/M | $0.28/M | $1.76 | ⭐⭐⭐⭐⭐ |
| **GPT-4o-mini** | $0.15/M | $0.60/M | $3.15 | ⭐⭐⭐⭐ |
| **GPT-4o** | $2.50/M | $10.00/M | $52.50 | ⭐⭐ |
| **Claude 3.5 Sonnet** | $3.00/M | $15.00/M | $75.60 | ⭐ |

**推荐**：回测使用 DeepSeek，节省成本 30-40 倍！

---

### 📊 成本估算工具

#### 在线计算器

```
回测成本 = 决策次数 × 单次 Token 消耗 × 模型价格

决策次数 = (结束时间 - 开始时间) ÷ 决策间隔
```

**示例 1**：
```
时长: 7 天
决策间隔: 1 小时
模型: DeepSeek

决策次数 = 7 × 24 = 168 次
Token 消耗 = 168 × 2,500 = 420,000
费用 = 420K × ($0.14 + $0.28) / 2 / 1M = $0.08
```

**示例 2**：
```
时长: 30 天
决策间隔: 3 分钟
模型: DeepSeek

决策次数 = 30 × 24 × 20 = 14,400 次
Token 消耗 = 14,400 × 2,500 = 36,000,000
费用 = 36M × ($0.14 + $0.28) / 2 / 1M = $7.56
```

---

### 💡 省钱技巧

#### 1. 使用 AI 缓存（最有效）

**原理**：相同的市场数据 + 相同的持仓 → 相同的 AI 决策

```bash
# 首次运行
Run 1: decision_timeframe=3m, 7天, initial_balance=10000
费用: $1.76
缓存: 已保存 3,360 个决策

# 修改参数重新测试（使用缓存）
Run 2: initial_balance=20000（其他参数不变）
费用: $0.00 ✅（100% 使用缓存）

Run 3: fee_bps=10（其他参数不变）
费用: $0.00 ✅

Run 4: decision_timeframe=15m（改变了时间框架）
费用: $0.35 ⚠️（部分缓存失效）
```

**节省率**：高达 90-100%

---

#### 2. 分阶段测试

```bash
Stage 1: 快速验证（1h 决策）
- 时长: 7 天
- 费用: $0.08
- 目的: 验证策略大方向是否正确

Stage 2: 精确测试（3m 决策）
- 时长: 3 天
- 费用: $0.75
- 目的: 精确验证实盘表现

总费用: $0.83
节省: 比直接测试 7 天（$1.76）省 53%
```

---

#### 3. 选择合适的时间范围

| 测试目的 | 推荐时长 | 费用 (3m频率) |
|---------|---------|--------------|
| 快速验证功能 | 1 小时 | < $0.01 |
| 日内策略测试 | 1-3 天 | $0.25-0.75 |
| 短期策略验证 | 7 天 | $1.76 |
| 完整月度评估 | 30 天 | $7.56 |
| 季度稳定性测试 | 90 天 | $22.68 |

**建议**：先短后长，逐步验证

---

## 最佳实践

### 🎯 回测流程建议

#### Phase 1: 快速验证（省钱）
```yaml
目的: 验证策略是否有明显缺陷

配置:
  decision_timeframe: 1h
  时长: 3-7 天
  symbols: 1-2 个

验收标准:
  - 总收益率 > 0%
  - 最大回撤 < 20%
  - 胜率 > 45%

如果不通过 → 修改策略，重新测试
如果通过 → 进入 Phase 2
```

---

#### Phase 2: 精确测试（接近实盘）
```yaml
目的: 精确模拟实盘表现

配置:
  decision_timeframe: 3m  # ← 与实盘一致
  时长: 1-3 天
  symbols: 实盘计划交易的币种

验收标准:
  - 总收益率 > 5%
  - 最大回撤 < 10%
  - 胜率 > 50%
  - 盈亏比 > 1.5

如果不通过 → 优化参数，重新测试
如果通过 → 进入 Phase 3
```

---

#### Phase 3: 长期稳定性验证
```yaml
目的: 验证策略长期稳定性

配置:
  decision_timeframe: 3m
  时长: 30-90 天
  symbols: 实盘计划交易的币种

测试多种市场环境:
  - 牛市（价格上涨）
  - 熊市（价格下跌）
  - 震荡市（横盘）

验收标准:
  - 不同市场环境都能盈利
  - 最大回撤 < 15%
  - 夏普比率 > 1.5

如果通过 → 可以考虑小资金实盘
```

---

#### Phase 4: 参数优化
```yaml
目的: 找到最优参数组合

使用网格搜索:
  杠杆: [5x, 10x, 20x]
  止损: [3%, 5%, 10%]
  止盈: [10%, 20%, 30%]

总组合数: 3 × 3 × 3 = 27 种

利用缓存:
  首次运行: 费用 × 27
  后续对比: 免费 ✅

选择标准:
  - 收益率最高
  - 回撤可接受
  - 符合风险偏好
```

---

### 📊 结果解读指南

#### 优秀策略的特征

```
✅ 收益指标:
  总收益率: > 10% (月度)
  年化收益率: > 120%
  夏普比率: > 1.5

✅ 风险指标:
  最大回撤: < 15%
  回撤恢复时间: < 7 天
  波动率: 适中

✅ 交易统计:
  胜率: > 50%
  盈亏比: > 1.5
  平均持仓时间: 适中（避免过度交易）
```

---

#### 警告信号

```
🚨 收益波动大:
  月收益: +50%, -30%, +40%, -20%
  → 策略不稳定，可能是过拟合

🚨 回撤过大:
  最大回撤: > 30%
  → 风险太高，可能爆仓

🚨 胜率极低:
  胜率: < 40%
  → 即使盈亏比高，心理压力大

🚨 过度交易:
  日均交易: > 50 笔
  → 手续费侵蚀利润
```

---

#### 常见陷阱

**1. 过拟合（Overfitting）**
```
现象:
  回测收益: +80%
  实盘收益: -20%

原因:
  策略针对历史数据优化过度
  未来市场环境变化

避免方法:
  - 在多个时间段测试
  - 避免过度优化参数
  - 保持策略简单（KISS 原则）
```

**2. 未来函数（Look-Ahead Bias）**
```
现象:
  回测使用了"未来"的数据

示例:
  当天 09:00 的决策使用了当天 15:00 的价格
  → 回测结果不可信

避免方法:
  - 确保数据时间戳正确
  - 只使用决策时间点之前的数据
```

**3. 幸存者偏差（Survivorship Bias）**
```
现象:
  只在表现好的币种上测试

示例:
  只测试 BTC（一直上涨）
  → 策略可能不适用其他币种

避免方法:
  - 在多个币种上测试
  - 包含表现差的币种
```

---

## 常见问题

### 💬 功能问题

#### Q1: 回测结果可靠吗？
**A**: 高度可靠，但有限制：

✅ **可靠的部分**：
- 使用真实的历史市场数据（Binance）
- 使用相同的 AI 决策引擎
- 考虑了真实的交易成本（手续费、滑点）
- 包含风险管理（爆仓检测、风控限制）

⚠️ **限制**：
- 历史不代表未来（市场环境会变化）
- 大单交易的滑点可能更大（回测默认固定滑点）
- 极端行情下的流动性问题（回测假设流动性充足）

**建议**：
- 回测结果作为参考，不是保证
- 实盘前先小资金验证
- 持续监控实盘表现与回测的偏差

---

#### Q2: 为什么回测收益和实盘不一样？
**A**: 常见原因：

1. **决策频率不一致**
   ```
   回测: 1h 决策
   实盘: 3m 决策
   → 结果必然不同
   ```

2. **市场环境变化**
   ```
   回测: 2024年1月（牛市）
   实盘: 2024年2月（震荡）
   → 策略可能不适应新环境
   ```

3. **实盘滑点更大**
   ```
   回测: 固定 0.02% 滑点
   实盘: 实际滑点 0.05-0.1%
   → 实盘收益低于回测
   ```

4. **过拟合**
   ```
   回测: 针对历史数据优化
   实盘: 面对新数据
   → 表现下降
   ```

**解决方法**：
- 确保回测参数与实盘一致
- 在多个时间段验证策略
- 实盘前预留安全边际（回测收益打 7 折）

---

#### Q3: 能回测多久以前的数据？
**A**: Binance API 限制：

- **理论上**：可以获取所有历史数据
- **实际建议**：
  - 最近 1-6 个月数据最可靠
  - 超过 1 年的数据市场环境差异大
  - 合约上线时间限制（如 BTCUSDT 合约从 2019 年开始）

**示例**：
```bash
# 可用
start: 2024-01-01
end: 2024-06-30
✅ 数据完整，市场环境相近

# 不推荐
start: 2020-01-01
end: 2024-01-01
⚠️ 跨度太长，市场环境变化大
```

---

### 💰 成本问题

#### Q4: 如何最大程度节省成本？
**A**: 5 个省钱技巧：

1. **使用 DeepSeek**
   ```
   DeepSeek: $1.76 (7天, 3m频率)
   GPT-4o: $52.50
   节省: 96%
   ```

2. **利用 AI 缓存**
   ```
   首次运行: $1.76
   后续测试（改参数）: $0.00
   节省: 100%
   ```

3. **降低决策频率（初期验证）**
   ```
   3m 频率: $1.76
   1h 频率: $0.08
   节省: 95%
   ```

4. **缩短测试时长（初期验证）**
   ```
   7 天: $1.76
   3 天: $0.75
   1 天: $0.25
   节省: 57-86%
   ```

5. **减少测试币种**
   ```
   5 个币种: $8.80
   2 个币种: $3.52
   节省: 60%
   ```

**综合使用**：
```bash
Phase 1: 快速验证
- DeepSeek + 1h 频率 + 3 天 + 2 币种
- 费用: < $0.10

Phase 2: 精确测试（利用缓存）
- DeepSeek + 3m 频率 + 3 天 + 2 币种
- 费用: ~$0.00（缓存）

总费用: < $0.10（相比直接测试省 90%）
```

---

#### Q5: 为什么有些决策不调用 AI？
**A**: 使用了缓存：

```bash
情况 1: 完全相同的市场状态
  时间: 2024-01-01 10:00
  BTCUSDT: 42000
  持仓: 空
  → 之前测试过 → 使用缓存 ✅

情况 2: 市场数据不同
  时间: 2024-01-01 11:00
  BTCUSDT: 42500  ← 变了
  → 缓存失效 → 调用 AI API

情况 3: 持仓不同
  时间: 2024-01-01 10:00
  BTCUSDT: 42000
  持仓: LONG 0.1 BTC  ← 有持仓
  → 缓存失效 → 调用 AI API
```

**缓存命中率**：
- 修改初始资金: ~100%
- 修改手续费: ~100%
- 修改时间范围: ~50%（部分重叠）
- 修改决策频率: ~0%（完全失效）

---

### 🔧 技术问题

#### Q6: Binance API 会限流吗？
**A**: 会，但正常使用不受影响：

**官方限制**：
```
IP 限流: 1200 请求/分钟
K线接口权重: 1-5/请求
单次返回上限: 1500 根 K 线
```

**实际消耗**：
```
7 天回测，3m 时间框架:
  需要数据: 3,360 根
  API 请求: 3 次
  耗时: ~1.5 秒

远低于限流阈值 ✅
```

**可能触发限流的场景**：
```
❌ 同时启动 100 个回测任务
❌ 回测 50+ 币种，90+ 天数据
❌ 高频重复请求相同数据
```

**应对方法**：
- 串行启动回测（不要并发）
- 遇到 429 错误等待 1 分钟重试
- 正常使用无需担心

---

#### Q7: 数据从哪里来？
**A**: Binance Futures 公开 API

**数据源**：
```
URL: https://fapi.binance.com/fapi/v1/klines
方法: GET
认证: 不需要（公开数据）
费用: 免费
```

**数据格式**：
```json
[
  [
    1704067200000,  // 开盘时间
    "42000.00",     // 开盘价
    "42500.00",     // 最高价
    "41800.00",     // 最低价
    "42300.00",     // 收盘价
    "1234.56",      // 成交量
    ...
  ]
]
```

**数据质量**：
- ✅ 官方数据，准确可靠
- ✅ 实时更新，无延迟
- ✅ 覆盖所有 Binance Futures 合约

**不是从这些地方**：
- ❌ 不是从 decision_logs（那是决策日志）
- ❌ 不是从本地文件
- ❌ 不是从数据库

---

#### Q8: 可以用自己的历史数据吗？
**A**: 当前版本不支持，但可以扩展：

**当前实现**：
```go
// backtest/datafeed.go:76
klines, err := market.GetKlinesRange(symbol, tf, fetchStart, fetchEnd)
// → 硬编码调用 Binance API
```

**如果需要自定义数据源**：

**方案 1**：修改 `market.GetKlinesRange()` 实现
```go
func GetKlinesRange(symbol, tf string, start, end time.Time) ([]Kline, error) {
    // 选项 1: 从本地 CSV 文件读取
    if useLocalData {
        return loadFromCSV(symbol, tf, start, end)
    }

    // 选项 2: 从数据库读取
    if useDatabase {
        return loadFromDB(symbol, tf, start, end)
    }

    // 默认: Binance API
    return fetchFromBinance(symbol, tf, start, end)
}
```

**方案 2**：实现数据接口
```go
type DataProvider interface {
    GetKlines(symbol, tf string, start, end time.Time) ([]Kline, error)
}

// Binance 实现
type BinanceProvider struct {}

// 自定义实现
type CustomProvider struct {
    dataPath string
}
```

**需要的数据格式**：
```go
type Kline struct {
    OpenTime  int64
    Open      float64
    High      float64
    Low       float64
    Close     float64
    Volume    float64
    CloseTime int64
}
```

---

## 技术细节

### 🏗️ 系统架构

```
┌─────────────────────────────────────────────────┐
│                   前端 (React)                   │
│  - BacktestPage.tsx: 配置界面                   │
│  - 进度监控、结果展示                            │
└─────────────────┬───────────────────────────────┘
                  │ HTTP API
┌─────────────────▼───────────────────────────────┐
│              后端 API (Gin)                      │
│  - POST /api/backtest/start                     │
│  - GET  /api/backtest/status                    │
│  - GET  /api/backtest/metrics                   │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│           Backtest Manager                      │
│  - 管理回测任务生命周期                         │
│  - 并发控制、状态管理                           │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│            Backtest Runner                      │
│  - 回测主循环                                    │
│  - 逐周期执行决策                               │
└───┬─────────────┬─────────────┬─────────────┬───┘
    │             │             │             │
┌───▼──┐    ┌────▼────┐   ┌───▼────┐   ┌───▼──────┐
│ Data │    │   AI    │   │Account │   │ Metrics  │
│ Feed │    │Decision │   │Manager │   │Calculator│
└──────┘    └─────────┘   └────────┘   └──────────┘
    │             │             │             │
┌───▼──────────────▼─────────────▼─────────────▼───┐
│             Binance API / AI API                  │
└───────────────────────────────────────────────────┘
```

---

### 🔄 回测执行流程

```
1. 配置验证
   ├─ 检查参数完整性
   ├─ 验证时间范围
   └─ 验证 AI 配置

2. 数据加载
   ├─ 从 Binance 获取历史 K 线
   ├─ 按时间排序
   └─ 预加载技术指标数据

3. 初始化账户
   ├─ 设置初始资金
   ├─ 初始化持仓为空
   └─ 重置统计指标

4. 主循环（逐周期）
   ├─ 获取当前周期市场数据
   ├─ 构建决策上下文
   │   ├─ 当前价格
   │   ├─ 历史数据
   │   ├─ 当前持仓
   │   └─ 账户状态
   ├─ 调用 AI 决策引擎
   │   ├─ 检查缓存
   │   ├─ 如未缓存 → 调用 AI API
   │   └─ 保存决策到缓存
   ├─ 执行交易决策
   │   ├─ 验证风险限制
   │   ├─ 计算手续费和滑点
   │   ├─ 更新持仓
   │   └─ 更新账户余额
   ├─ 记录交易日志
   ├─ 检查爆仓风险
   └─ 更新净值曲线

5. 生成报告
   ├─ 计算收益指标
   ├─ 计算风险指标
   ├─ 统计交易数据
   └─ 生成可视化图表
```

---

### 📦 核心模块说明

#### 1. DataFeed (数据源)
```go
// backtest/datafeed.go
type DataFeed struct {
    symbols      []string        // 交易币对列表
    timeframes   []string        // 时间框架 ["3m", "15m", "4h"]
    symbolSeries map[string]*symbolSeries  // K线数据
}

// 核心方法
func (df *DataFeed) BuildMarketData(ts int64) (map[string]*market.Data, error)
// → 构建指定时间点的市场数据快照
```

**工作原理**：
```
时间: 2024-01-01 10:00

BuildMarketData(1704106800000) →
{
  "BTCUSDT": {
    "3m":  [最近 200 根 3m K 线],
    "15m": [最近 100 根 15m K 线],
    "4h":  [最近 50 根 4h K 线]
  }
}
```

---

#### 2. BacktestAccount (账户管理)
```go
// backtest/account.go
type BacktestAccount struct {
    initialBalance float64           // 初始资金
    cash           float64           // 可用余额
    positions      map[string]*position  // 持仓列表
    realizedPnL    float64           // 已实现盈亏
}

// 核心方法
func (acc *BacktestAccount) Open(symbol, side string, quantity float64, leverage int, price float64, ts int64) (*position, float64, float64, error)
func (acc *BacktestAccount) Close(symbol, side string, quantity float64, price float64) (float64, float64, float64, error)
func (acc *BacktestAccount) TotalEquity(priceMap map[string]float64) (float64, float64, map[string]float64)
```

**风险保护**（我们添加的）：
```go
const MaxLeverage = 100           // 最大杠杆
const MaxPositions = 20            // 最大持仓数
const MaxNotionalMultiplier = 50.0 // 最大名义价值倍数
```

---

#### 3. AICache (AI 决策缓存)
```go
// backtest/aicache.go
type AICache struct {
    path    string
    Entries map[string]cachedDecision
}

// 缓存键计算
func computeCacheKey(ctx *decision.Context, variant string, ts int64) (string, error)
// → SHA256(市场数据 + 持仓状态 + 时间戳 + prompt变体)
```

**缓存策略**：
```
缓存命中条件:
- 相同的时间戳
- 相同的市场数据（价格、成交量）
- 相同的持仓状态
- 相同的 prompt 模板

任一条件变化 → 缓存失效 → 重新调用 AI
```

---

#### 4. Runner (回测引擎)
```go
// backtest/runner.go
type Runner struct {
    cfg            BacktestConfig
    account        *BacktestAccount
    dataFeed       *DataFeed
    decisionLogger logger.IDecisionLogger
    mcpClient      mcp.AIClient
}

// 主循环
func (r *Runner) loop() error {
    for _, ts := range r.dataFeed.decisionTimes {
        // 1. 获取市场数据
        marketData := r.dataFeed.BuildMarketData(ts)

        // 2. 调用 AI 决策
        decision := r.invokeAIWithRetry(ctx)

        // 3. 执行交易
        r.executeDecision(decision, ts)

        // 4. 检查爆仓
        r.checkLiquidation(ts)

        // 5. 更新状态
        r.updateState(ts)
    }
}
```

---

### 🔒 安全特性（我们添加的）

#### 1. API Key 脱敏
```go
// logger/decision_logger.go:96-116
func RedactSensitiveInfo(text string) string {
    // 脱敏 sk-xxx, key_xxx 格式
    apiKeyPattern := regexp.MustCompile(`\b(sk-|key_)([a-zA-Z0-9]{4})[a-zA-Z0-9]{8,}([a-zA-Z0-9]{4})\b`)
    text = apiKeyPattern.ReplaceAllString(text, "${1}${2}**********${3}")

    // 脱敏十六进制私钥
    hexKeyPattern := regexp.MustCompile(`\b0x([a-fA-F0-9]{4})[a-fA-F0-9]{32,}([a-fA-F0-9]{4})\b`)
    text = hexKeyPattern.ReplaceAllString(text, "0x${1}**********${2}")

    return text
}
```

**示例**：
```
输入: "API Key: sk-1234567890abcdefghij"
输出: "API Key: sk-1234**********ghij"

输入: "Private Key: 0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
输出: "Private Key: 0xabcd**********7890"
```

---

#### 2. 风险限制
```go
// backtest/account.go:69-92
// 1. 杠杆限制
if leverage > 100 {
    return error("exceeds maximum allowed leverage of 100")
}

// 2. 持仓数量限制
if len(acc.positions) >= 20 {
    return error("maximum position count (20) reached")
}

// 3. 名义价值限制
if notional > totalEquity * 50.0 {
    return error("notional value exceeds maximum allowed")
}
```

**保护效果**：
- 防止不现实的回测结果（如 1000x 杠杆赚 1000%）
- 确保回测结果可参考性
- 降低实盘使用时的风险

---

### 📊 性能优化

#### 1. 数据预加载
```go
// 启动时一次性加载所有数据
func (df *DataFeed) loadAll() error {
    for _, symbol := range df.symbols {
        for _, tf := range df.timeframes {
            klines := market.GetKlinesRange(symbol, tf, start, end)
            df.symbolSeries[symbol][tf] = klines
        }
    }
}

// 回测循环中直接使用内存数据（无 IO）
marketData := df.BuildMarketData(ts)  // O(1) 查找
```

**性能提升**：
- 避免重复 API 调用
- 回测速度：7 天数据 < 30 秒

---

#### 2. AI 缓存
```go
// 决策前先查缓存
if cachedDecision, ok := aiCache.Get(cacheKey); ok {
    return cachedDecision  // 直接返回，不调用 API
}

// 缓存未命中才调用 AI
decision := callAIAPI(prompt)
aiCache.Put(cacheKey, decision)  // 保存供后续使用
```

**性能提升**：
- 重复测试几乎免费
- 响应时间：从 2s 降到 < 0.01s

---

## 📝 更新日志

### v1.0 (2025-01-15)
- ✅ 完整的回测功能上线
- ✅ 前端界面和导航
- ✅ API Key 安全脱敏
- ✅ 风险保护限制
- ✅ HTTP 状态码修复
- ✅ AI 客户端接口兼容
- ✅ 支持 DeepSeek/GPT-4/Claude
- ✅ AI 决策缓存
- ✅ 完整的测试覆盖

---

## 🙋 获取帮助

### 问题反馈
- GitHub Issues: [nofxai/nofx/issues](https://github.com/nofxai/nofx/issues)
- 邮件: support@nofx.ai

### 贡献指南
欢迎提交 PR 改进回测功能！

---

## ⚖️ 免责声明

**⚠️ 重要提示**：

1. **回测结果仅供参考**
   - 历史表现不代表未来收益
   - 实盘结果可能与回测存在偏差

2. **风险提示**
   - 加密货币交易存在高风险
   - 可能损失全部投资本金
   - 请根据自身风险承受能力谨慎决策

3. **不构成投资建议**
   - 本系统仅为技术工具
   - 不构成任何投资建议
   - 用户需自行承担交易风险

4. **使用责任**
   - 用户对使用本系统的一切后果负责
   - 开发者不对任何损失负责

**使用本系统即表示您已阅读并同意上述免责声明。**

---

## 📄 许可证

AGPL-3.0 License

---

**Happy Backtesting! 🚀**
